<!DOCTYPE html>
<html lang="{{ page.lang | default: site.lang | default: "es" }}">

  {%- include head.html -%}

  <body>

    <!-- Skip to main content for accessibility -->
    <a class="sr-only" href="#main-content">Saltar al contenido principal</a>

    {%- include header.html -%}

    <!-- Progress bar for reading progress -->
    <div id="reading-progress" style="position: fixed; top: 0; left: 0; width: 0%; height: 3px; background: linear-gradient(90deg, #2563eb, #059669); z-index: 9999; transition: width 0.3s ease;"></div>

    <!-- Breadcrumb Navigation -->
    {% unless page.url == "/" %}
    <nav class="breadcrumb-nav" aria-label="breadcrumb">
      <div class="wrapper">
        <ol class="breadcrumb">
          <li class="breadcrumb-item">
            <a href="{{ '/' | relative_url }}">🏠 Inicio</a>
          </li>
          {% assign crumbs = page.url | remove:'/index.html' | split: '/' %}
          {% for crumb in crumbs offset: 1 %}
            {% if forloop.last %}
              <li class="breadcrumb-item active" aria-current="page">
                {{ page.title | default: crumb | replace:'-',' ' | remove:'.html' | capitalize }}
              </li>
            {% else %}
              {% assign crumb_limit = forloop.index | plus: 1 %}
              {% assign crumb_url = crumbs | first: crumb_limit | join: '/' | prepend: '/' %}
              <li class="breadcrumb-item">
                <a href="{{ crumb_url | relative_url }}">{{ crumb | replace:'-',' ' | remove:'.html' | capitalize }}</a>
              </li>
            {% endif %}
          {% endfor %}
        </ol>
      </div>
    </nav>
    {% endunless %}

    <!-- Table of Contents (for long pages) -->
    {% if page.toc != false and content contains '<h2' %}
    <nav class="toc-nav" id="toc-nav" aria-label="tabla de contenidos">
      <div class="toc-header">
        <h3>📑 Contenido</h3>
        <button class="toc-toggle" id="toc-toggle" aria-label="Alternar tabla de contenidos">
          <span class="toc-icon">▼</span>
        </button>
      </div>
      <div class="toc-content" id="toc-content">
        <!-- TOC will be generated by JavaScript -->
      </div>
    </nav>
    {% endif %}

    <!-- Main Content -->
    <main class="page-content" aria-label="Contenido principal" id="main-content">
      <div class="wrapper">

        <!-- Page Header with metadata -->
        {% if page.layout != 'home' %}
        <header class="page-header">
          {% if page.last_modified_at or page.date %}
          <div class="page-meta">
            {% if page.date %}
              <span class="page-date">📅 {{ page.date | date: "%d/%m/%Y" }}</span>
            {% endif %}
            {% if page.last_modified_at %}
              <span class="page-updated">🔄 Actualizado: {{ page.last_modified_at | date: "%d/%m/%Y" }}</span>
            {% endif %}
            {% if page.reading_time %}
              <span class="reading-time">⏱️ {{ page.reading_time }} min de lectura</span>
            {% endif %}
          </div>
          {% endif %}

          {% if page.badges %}
          <div class="page-badges">
            {% for badge in page.badges %}
              <span class="badge badge-{{ badge.type | default: 'primary' }}">{{ badge.text }}</span>
            {% endfor %}
          </div>
          {% endif %}
        </header>
        {% endif %}

        <!-- Emergency Banner (if needed) -->
        {% if page.emergency %}
        <div class="emergency-banner">
          <div class="emergency-icon">🚨</div>
          <div class="emergency-content">
            <h4>{{ page.emergency.title | default: "Situación de Emergencia" }}</h4>
            <p>{{ page.emergency.message }}</p>
            {% if page.emergency.action_url %}
              <a href="{{ page.emergency.action_url }}" class="btn btn-danger">{{ page.emergency.action_text | default: "Obtener Ayuda Ahora" }}</a>
            {% endif %}
          </div>
        </div>
        {% endif %}

        <!-- Page Content -->
        <article class="page-article">
          {{ content }}
        </article>

        <!-- Page Navigation (Previous/Next) -->
        {% if page.nav_previous or page.nav_next %}
        <nav class="page-navigation" aria-label="navegación de página">
          <div class="nav-links">
            {% if page.nav_previous %}
            <div class="nav-previous">
              <a href="{{ page.nav_previous.url | relative_url }}" class="nav-link">
                <span class="nav-direction">← Anterior</span>
                <span class="nav-title">{{ page.nav_previous.title }}</span>
              </a>
            </div>
            {% endif %}
            {% if page.nav_next %}
            <div class="nav-next">
              <a href="{{ page.nav_next.url | relative_url }}" class="nav-link">
                <span class="nav-direction">Siguiente →</span>
                <span class="nav-title">{{ page.nav_next.title }}</span>
              </a>
            </div>
            {% endif %}
          </div>
        </nav>
        {% endif %}

        <!-- Related Pages -->
        {% if page.related %}
        <section class="related-pages">
          <h3>📚 Recursos Relacionados</h3>
          <div class="related-grid">
            {% for related in page.related %}
            <a href="{{ related.url | relative_url }}" class="related-card">
              <div class="related-icon">{{ related.icon | default: "📄" }}</div>
              <div class="related-content">
                <h4>{{ related.title }}</h4>
                <p>{{ related.description }}</p>
              </div>
            </a>
            {% endfor %}
          </div>
        </section>
        {% endif %}

        <!-- Feedback Section -->
        {% unless page.hide_feedback %}
        <section class="feedback-section">
          <div class="feedback-content">
            <h3>💬 ¿Te ha sido útil esta información?</h3>
            <p>Tu opinión nos ayuda a mejorar estos recursos para todas las familias.</p>
            <div class="feedback-buttons">
              <button class="btn btn-outline feedback-btn" data-feedback="helpful">
                👍 Sí, me ha ayudado
              </button>
              <button class="btn btn-outline feedback-btn" data-feedback="not-helpful">
                👎 Necesita mejoras
              </button>
            </div>
            <div class="feedback-thanks" id="feedback-thanks" style="display: none;">
              <p>¡Gracias por tu feedback! 🙏</p>
            </div>
          </div>
        </section>
        {% endunless %}

      </div>
    </main>

    <!-- Back to Top Button -->
    <button class="back-to-top" id="back-to-top" aria-label="Volver al inicio" title="Volver al inicio">
      ↑
    </button>

    {%- include footer.html -%}

    <!-- JavaScript for enhanced functionality -->
    <script>
      // Reading progress bar
      function updateReadingProgress() {
        const winScroll = document.body.scrollTop || document.documentElement.scrollTop;
        const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
        const scrolled = (winScroll / height) * 100;
        document.getElementById('reading-progress').style.width = scrolled + '%';
      }

      // Table of Contents generation
      function generateTOC() {
        const tocContent = document.getElementById('toc-content');
        if (!tocContent) return;

        const headings = document.querySelectorAll('h2, h3');
        if (headings.length === 0) return;

        const tocList = document.createElement('ul');
        tocList.className = 'toc-list';

        headings.forEach((heading, index) => {
          // Add ID to heading if it doesn't have one
          if (!heading.id) {
            heading.id = 'heading-' + index;
          }

          const listItem = document.createElement('li');
          listItem.className = 'toc-item toc-' + heading.tagName.toLowerCase();

          const link = document.createElement('a');
          link.href = '#' + heading.id;
          link.textContent = heading.textContent;
          link.className = 'toc-link';

          listItem.appendChild(link);
          tocList.appendChild(listItem);
        });

        tocContent.appendChild(tocList);
      }

      // TOC toggle functionality
      function setupTOCToggle() {
        const toggle = document.getElementById('toc-toggle');
        const content = document.getElementById('toc-content');

        if (!toggle || !content) return;

        toggle.addEventListener('click', function() {
          content.classList.toggle('toc-collapsed');
          const icon = toggle.querySelector('.toc-icon');
          icon.textContent = content.classList.contains('toc-collapsed') ? '▶' : '▼';
        });
      }

      // Back to top functionality
      function setupBackToTop() {
        const backToTop = document.getElementById('back-to-top');
        if (!backToTop) return;

        window.addEventListener('scroll', function() {
          if (window.pageYOffset > 300) {
            backToTop.style.display = 'flex';
          } else {
            backToTop.style.display = 'none';
          }
        });

        backToTop.addEventListener('click', function() {
          window.scrollTo({
            top: 0,
            behavior: 'smooth'
          });
        });
      }

      // Feedback functionality
      function setupFeedback() {
        const feedbackButtons = document.querySelectorAll('.feedback-btn');
        const thankMessage = document.getElementById('feedback-thanks');

        feedbackButtons.forEach(button => {
          button.addEventListener('click', function() {
            const feedback = this.getAttribute('data-feedback');

            // Hide buttons and show thanks
            feedbackButtons.forEach(btn => btn.style.display = 'none');
            if (thankMessage) {
              thankMessage.style.display = 'block';
            }

            // You could send this data to analytics here
            console.log('Feedback:', feedback);
          });
        });
      }

      // Smooth scrolling for anchor links
      function setupSmoothScrolling() {
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
          anchor.addEventListener('click', function (e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
              target.scrollIntoView({
                behavior: 'smooth',
                block: 'start'
              });
            }
          });
        });
      }

      // Initialize everything when DOM is loaded
      document.addEventListener('DOMContentLoaded', function() {
        generateTOC();
        setupTOCToggle();
        setupBackToTop();
        setupFeedback();
        setupSmoothScrolling();

        // Update reading progress on scroll
        window.addEventListener('scroll', updateReadingProgress);
        updateReadingProgress(); // Initial call
      });

      // Keyboard navigation
      document.addEventListener('keydown', function(e) {
        // ESC key to close TOC
        if (e.key === 'Escape') {
          const tocContent = document.getElementById('toc-content');
          if (tocContent && !tocContent.classList.contains('toc-collapsed')) {
            document.getElementById('toc-toggle').click();
          }
        }
      });
    </script>

  </body>

</html>
